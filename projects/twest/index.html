import React, { useEffect, useMemo, useRef, useState } from "react";
import { motion } from "framer-motion";
import { Play, Pause, RotateCcw, SkipForward, Bell, BellOff, Settings, Moon, Sun, ChartLine } from "lucide-react";

// --- Utilities ---------------------------------------------------------------
const clamp = (v, min, max) => Math.min(Math.max(v, min), max);
const pad = (n) => String(n).padStart(2, "0");
const fmt = (sec) => `${pad(Math.floor(sec / 60))}:${pad(Math.floor(sec % 60))}`;
const todayKey = () => new Date().toISOString().slice(0, 10);

// Storage helpers
const load = (k, d) => {
  try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; } catch { return d; }
};
const save = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} };

// Beep generator (Web Audio API)
function useBeep(enabled) {
  const ctxRef = useRef(null);
  const beep = () => {
    if (!enabled) return;
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    if (!AudioCtx) return;
    if (!ctxRef.current) ctxRef.current = new AudioCtx();
    const ctx = ctxRef.current;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.type = "sine"; o.frequency.value = 880; // A5
    g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.3, ctx.currentTime + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.35);
    o.start(); o.stop(ctx.currentTime + 0.4);
  };
  return beep;
}

// Desktop notifications
async function ensureNotifyPerm(enabled) {
  if (!enabled || !("Notification" in window)) return false;
  if (Notification.permission === "granted") return true;
  if (Notification.permission === "denied") return false;
  const res = await Notification.requestPermission();
  return res === "granted";
}

function notify(title, body) {
  if (!("Notification" in window)) return;
  if (Notification.permission !== "granted") return;
  new Notification(title, { body });
}

// --- Main Component ----------------------------------------------------------
export default function PomodoroApp() {
  // Settings
  const [settingsOpen, setSettingsOpen] = useState(false);
  const [durationsOpen, setDurationsOpen] = useState(false); // NEW quick dialog
  const [cfg, setCfg] = useState(() => load("pz_cfg", {
    focusMin: 25,
    shortMin: 5,
    longMin: 15,
    cycles: 4,
    autoStartNext: true,
    sound: true,
    desktopNotify: false,
    dark: window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches,
  }));

  useEffect(() => save("pz_cfg", cfg), [cfg]);

  // Theme
  useEffect(() => {
    document.documentElement.classList.toggle("dark", !!cfg.dark);
  }, [cfg.dark]);

  // Timer state
  const [phase, setPhase] = useState("focus"); // 'focus' | 'short' | 'long'
  const [remaining, setRemaining] = useState(cfg.focusMin * 60);
  const [running, setRunning] = useState(false);
  const [completedFocus, setCompletedFocus] = useState(0);
  const [cycleIndex, setCycleIndex] = useState(1); // 1..cfg.cycles

  const totalForPhase = useMemo(() => (
    phase === "focus" ? cfg.focusMin * 60 : phase === "short" ? cfg.shortMin * 60 : cfg.longMin * 60
  ), [phase, cfg.focusMin, cfg.shortMin, cfg.longMin]);

  // Stats (per day minutes focused)
  const [stats, setStats] = useState(() => load("pz_stats", { [todayKey()]: 0 }));
  useEffect(() => save("pz_stats", stats), [stats]);

  const beep = useBeep(cfg.sound);

  // Tick
  useEffect(() => {
    if (!running) return;
    const id = setInterval(() => {
      setRemaining((s) => {
        if (s <= 1) return 0;
        return s - 1;
      });
    }, 1000);
    return () => clearInterval(id);
  }, [running]);

  // On phase complete
  useEffect(() => {
    if (remaining !== 0) return;
    // Award focus minutes
    if (phase === "focus") {
      setCompletedFocus((n) => n + 1);
      const key = todayKey();
      setStats((st) => ({ ...st, [key]: (st[key] || 0) + cfg.focusMin }));
    }
    beep();
    ensureNotifyPerm(cfg.desktopNotify).then((ok) => {
      if (ok) notify(
        phase === "focus" ? "Focus complete!" : "Break over!",
        phase === "focus" ? (cycleIndex === cfg.cycles ? "Long break starts." : "Short break time.") : "Back to focus."
      );
    });
    // Advance
    nextPhase();
    // Auto-start next if enabled
    setRunning(cfg.autoStartNext);
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [remaining]);

  const resetTo = (ph) => {
    setPhase(ph);
    setRemaining(ph === "focus" ? cfg.focusMin * 60 : ph === "short" ? cfg.shortMin * 60 : cfg.longMin * 60);
  };

  const nextPhase = () => {
    if (phase === "focus") {
      if (cycleIndex >= cfg.cycles) {
        setCycleIndex(1);
        resetTo("long");
      } else {
        setCycleIndex((i) => i + 1);
        resetTo("short");
      }
    } else {
      resetTo("focus");
    }
  };

  // When settings change, resync remaining for current phase to avoid confusion
  useEffect(() => {
    resetTo(phase);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [cfg.focusMin, cfg.shortMin, cfg.longMin]);

  // Keyboard shortcuts
  useEffect(() => {
    const onKey = (e) => {
      if (e.code === "Space") { e.preventDefault(); setRunning((r) => !r); }
      if (e.key.toLowerCase() === "r") { e.preventDefault(); handleReset(); }
      if (e.key.toLowerCase() === "s") { e.preventDefault(); handleSkip(); }
    };
    window.addEventListener("keydown", onKey);
    return () => window.removeEventListener("keydown", onKey);
  });

  const handleReset = () => {
    setRunning(false);
    resetTo("focus");
    setCycleIndex(1);
  };

  const handleSkip = () => {
    setRunning(false);
    nextPhase();
  };

  // Progress ring
  const pct = remaining / totalForPhase;
  const size = 240, stroke = 14;
  const r = (size - stroke) / 2;
  const C = 2 * Math.PI * r;
  const dash = clamp(C * pct, 0, C);

  // Helpers for form controls
  const numberInput = (label, key, min, max) => (
    <div className="flex items-center justify-between gap-3">
      <label className="text-sm text-muted-foreground w-36">{label}</label>
      <input
        type="number"
        min={min}
        max={max}
        value={cfg[key]}
        onChange={(e) => setCfg({ ...cfg, [key]: clamp(parseInt(e.target.value || "0"), min, max) })}
        className="w-24 rounded-xl border px-3 py-2 bg-background"
      />
      <span className="text-xs text-muted-foreground">min</span>
    </div>
  );

  const toggleInput = (label, key, iconOn, iconOff) => (
    <button
      onClick={async () => {
        if (key === "desktopNotify" && !cfg.desktopNotify) {
          await ensureNotifyPerm(true);
        }
        setCfg({ ...cfg, [key]: !cfg[key] });
      }}
      className={`flex items-center justify-between gap-3 w-full rounded-xl border px-3 py-2 hover:bg-muted`}
    >
      <span className="text-sm text-left text-muted-foreground">{label}</span>
      <span className="shrink-0">{cfg[key] ? iconOn : iconOff}</span>
    </button>
  );

  const totalFocusedToday = stats[todayKey()] || 0;

  return (
    <div className="min-h-screen bg-background text-foreground transition-colors">
      <div className="max-w-4xl mx-auto p-6">
        {/* Header */}
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-3">
            <div className="w-8 h-8 rounded-2xl bg-primary/10 flex items-center justify-center">⏳</div>
            <h1 className="text-2xl font-semibold">Pomodoro</h1>
            <span className="text-xs px-2 py-1 rounded-lg bg-muted text-muted-foreground">Focus • Break • Repeat</span>
          </div>
          <div className="flex items-center gap-2">
            <button
              onClick={() => setCfg({ ...cfg, dark: !cfg.dark })}
              className="rounded-xl border px-3 py-2 hover:bg-muted flex items-center gap-2"
              title="Toggle theme"
            >
              {cfg.dark ? <Sun size={16}/> : <Moon size={16}/>}<span className="hidden sm:inline text-sm">Theme</span>
            </button>
            <button
              onClick={() => setSettingsOpen((s) => !s)}
              className="rounded-xl border px-3 py-2 hover:bg-muted flex items-center gap-2"
              title="Settings"
            >
              <Settings size={16}/><span className="hidden sm:inline text-sm">Settings</span>
            </button>
          </div>
        </div>

        {/* Grid */}
        <div className="grid md:grid-cols-2 gap-6">
          {/* Timer Card */}
          <motion.div layout className="rounded-2xl border p-6 bg-card shadow-sm">
            <div className="flex items-center justify-between mb-2">
              <div className="flex items-center gap-2">
                <span className={`text-xs px-2 py-1 rounded-lg ${phase === 'focus' ? 'bg-green-500/10 text-green-600' : 'bg-blue-500/10 text-blue-600'}`}>{phase === 'focus' ? 'Focus' : phase === 'short' ? 'Short Break' : 'Long Break'}</span>
                <span className="text-xs text-muted-foreground">Cycle {cycleIndex}/{cfg.cycles}</span>
              </div>
              <div className="flex items-center gap-2 text-muted-foreground">
                {cfg.sound ? <Bell size={16}/> : <BellOff size={16}/>}
                {/* NEW: quick durations button */}
                <button
                  onClick={() => setDurationsOpen(true)}
                  className="rounded-xl border px-2.5 py-1.5 hover:bg-muted text-xs"
                  title="調整工作／休息時長"
                >調整時長</button>
              </div>
            </div>

            <div className="flex flex-col items-center">
              <div className="relative" style={{ width: size, height: size }}>
                <svg width={size} height={size} className="rotate-[-90deg]">
                  <circle cx={size/2} cy={size/2} r={r} strokeWidth={stroke} className="fill-none stroke-muted" />
                  <motion.circle
                    cx={size/2}
                    cy={size/2}
                    r={r}
                    strokeWidth={stroke}
                    className="fill-none stroke-primary"
                    strokeLinecap="round"
                    strokeDasharray={`${C} ${C}`}
                    animate={{ strokeDashoffset: C - dash }}
                    transition={{ type: "spring", stiffness: 120, damping: 20 }}
                  />
                </svg>
                <div className="absolute inset-0 grid place-content-center">
                  <div className="text-6xl font-bold tabular-nums">{fmt(remaining)}</div>
                </div>
              </div>

              <div className="mt-6 flex items-center gap-3">
                <button
                  onClick={() => setRunning((r) => !r)}
                  className="rounded-2xl px-5 py-3 bg-primary text-primary-foreground shadow hover:opacity-90 flex items-center gap-2"
                >
                  {running ? <Pause size={18}/> : <Play size={18}/>} {running ? "Pause" : remaining === totalForPhase ? "Start" : "Resume"}
                </button>
                <button onClick={handleReset} className="rounded-2xl border px-4 py-3 hover:bg-muted flex items-center gap-2"><RotateCcw size={18}/>Reset</button>
                <button onClick={handleSkip} className="rounded-2xl border px-4 py-3 hover:bg-muted flex items-center gap-2"><SkipForward size={18}/>Skip</button>
              </div>

              <p className="mt-4 text-xs text-muted-foreground">Shortcuts: Space = Start/Pause • R = Reset • S = Skip</p>
            </div>
          </motion.div>

          {/* Right Column */}
          <motion.div layout className="rounded-2xl border p-6 bg-card shadow-sm space-y-6">
            {/* Settings Panel */}
            <div>
              <div className="flex items-center justify-between mb-3">
                <h2 className="text-lg font-semibold">Settings</h2>
                <button
                  onClick={() => setSettingsOpen((s) => !s)}
                  className="text-sm text-muted-foreground underline"
                >{settingsOpen ? "Hide" : "Show"}</button>
              </div>
              {settingsOpen && (
                <div className="space-y-3">
                  {numberInput("Focus duration", "focusMin", 1, 180)}
                  {numberInput("Short break", "shortMin", 1, 60)}
                  {numberInput("Long break", "longMin", 1, 120)}
                  <div className="flex items-center justify-between gap-3">
                    <label className="text-sm text-muted-foreground w-36">Cycles per set</label>
                    <input type="number" min={1} max={12} value={cfg.cycles} onChange={(e)=>setCfg({...cfg, cycles: clamp(parseInt(e.target.value||"0"),1,12)})} className="w-24 rounded-xl border px-3 py-2 bg-background"/>
                    <span className="text-xs text-muted-foreground">focus → short</span>
                  </div>
                  {toggleInput("Auto-start next session", "autoStartNext", <span className="text-xs">On</span>, <span className="text-xs">Off</span>)}
                  {toggleInput("Sound alert", "sound", <Bell size={16}/>, <BellOff size={16}/>)}
                  {toggleInput("Desktop notifications", "desktopNotify", <span className="text-xs">On</span>, <span className="text-xs">Off</span>)}
                </div>
              )}
            </div>

            {/* Session Switcher */}
            <div>
              <h2 className="text-lg font-semibold mb-3">Session</h2>
              <div className="grid grid-cols-3 gap-2">
                {["focus","short","long"].map((p)=> (
                  <button key={p} onClick={()=>{ setRunning(false); resetTo(p); }}
                    className={`rounded-xl border px-3 py-2 hover:bg-muted ${phase===p? 'bg-muted' : ''}`}
                  >{p === 'focus' ? 'Focus' : p === 'short' ? 'Short Break' : 'Long Break'}</button>
                ))}
              </div>
            </div>

            {/* Mini Stats */}
            <div>
              <h2 className="text-lg font-semibold mb-2 flex items-center gap-2"><ChartLine size={18}/> Today</h2>
              <div className="grid grid-cols-3 gap-3">
                <div className="rounded-xl border p-3 text-center">
                  <div className="text-xs text-muted-foreground">Focused</div>
                  <div className="text-xl font-semibold">{totalFocusedToday}m</div>
                </div>
                <div className="rounded-xl border p-3 text-center">
                  <div className="text-xs text-muted-foreground">Completed</div>
                  <div className="text-xl font-semibold">{completedFocus}</div>
                </div>
                <div className="rounded-xl border p-3 text-center">
                  <div className="text-xs text-muted-foreground">Next</div>
                  <div className="text-xl font-semibold">{phase === 'focus' ? 'Break' : 'Focus'}</div>
                </div>
              </div>
            </div>

            {/* Tips */}
            <div className="text-xs text-muted-foreground leading-relaxed">
              Pro tip: Keep focus sessions short and intense. Use long breaks to walk, stretch, or hydrate.
            </div>
          </motion.div>
        </div>

        {/* Footer */}
        <div className="mt-8 text-center text-xs text-muted-foreground">
          Built with ❤️ • Your work compounds when you protect your focus.
        </div>
      </div>

      {/* NEW: Quick Durations Dialog */}
      {durationsOpen && (
        <div className="fixed inset-0 z-50 grid place-items-center">
          <div className="absolute inset-0 bg-black/40" onClick={() => setDurationsOpen(false)} />
          <div className="relative w-[90vw] max-w-md rounded-2xl border bg-card p-5 shadow-xl">
            <h3 className="text-lg font-semibold mb-3">調整工作／休息時長</h3>
            <div className="space-y-3">
              <div className="flex items-center justify-between gap-3">
                <label className="text-sm text-muted-foreground">專注（分鐘）</label>
                <input type="number" min={1} max={180} value={cfg.focusMin}
                  onChange={(e)=> setCfg({...cfg, focusMin: clamp(parseInt(e.target.value||"0"),1,180)})}
                  className="w-28 rounded-xl border px-3 py-2 bg-background"/>
              </div>
              <div className="flex items-center justify-between gap-3">
                <label className="text-sm text-muted-foreground">短休息（分鐘）</label>
                <input type="number" min={1} max={60} value={cfg.shortMin}
                  onChange={(e)=> setCfg({...cfg, shortMin: clamp(parseInt(e.target.value||"0"),1,60)})}
                  className="w-28 rounded-xl border px-3 py-2 bg-background"/>
              </div>
              <div className="flex items-center justify-between gap-3">
                <label className="text-sm text-muted-foreground">長休息（分鐘）</label>
                <input type="number" min={1} max={120} value={cfg.longMin}
                  onChange={(e)=> setCfg({...cfg, longMin: clamp(parseInt(e.target.value||"0"),1,120)})}
                  className="w-28 rounded-xl border px-3 py-2 bg-background"/>
              </div>
            </div>
            <div className="mt-5 flex items-center justify-end gap-2">
              <button onClick={()=> setDurationsOpen(false)} className="rounded-xl border px-4 py-2 hover:bg-muted">關閉</button>
              <button onClick={()=> { resetTo(phase); setDurationsOpen(false); }} className="rounded-xl px-4 py-2 bg-primary text-primary-foreground">套用</button>
            </div>
            <p className="mt-2 text-[11px] text-muted-foreground">提示：變更後會同步更新目前階段的剩餘時間。</p>
          </div>
        </div>
      )}
    </div>
  );
}

// Tailwind preset notes (for reference):
// The canvas preview environment includes Tailwind + a design system that maps these utility
// classes: bg-background/foreground, bg-card, bg-muted, text-muted-foreground, bg-primary, etc.
// If you copy this into your own project, ensure your Tailwind config defines CSS variables
// or replace these tokens with your palette.
