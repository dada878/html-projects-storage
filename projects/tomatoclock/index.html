<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>番茄鐘 Pomodoro（純 HTML＋JS）</title>
<style>
  :root{
    --bg:#f8fafc;--panel:#ffffff;--ink:#0f172a;--muted:#64748b;--line:#e2e8f0;--primary:#0f172a;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif;background:linear-gradient(#fff,#f8fafc);color:var(--ink)}
  .wrap{max-width:960px;margin:0 auto;padding:24px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:40px;height:40px;border-radius:12px;background:var(--ink);color:#fff;display:grid;place-items:center;box-shadow:0 8px 20px rgba(15,23,42,.15)}
  h1{margin:0;font-size:22px}
  .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#fff;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
  .btn.primary{background:var(--ink);color:#fff;border-color:var(--ink)}
  .btn.ghost{background:transparent}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 24px rgba(15,23,42,.06)}
  .card-h{padding:16px 20px;border-bottom:1px solid var(--line)}
  .card-b{padding:20px}
  .title{font-weight:700}
  .desc{color:var(--muted);font-size:14px}
  .center{display:grid;place-items:center}
  .timer{width:280px;height:280px;position:relative}
  .mmss{position:absolute;inset:0;display:grid;place-items:center;font-size:56px;font-weight:700;letter-spacing:.5px}
  .controls{display:flex;gap:12px;justify-content:center;margin-top:20px}
  .progress{height:8px;background:#eef2f7;border-radius:999px;overflow:hidden;margin-top:16px}
  .progress>i{display:block;height:100%;background:var(--ink);width:0%}
  footer{margin-top:28px;text-align:center;color:var(--muted);font-size:12px}
  /* modal */
  dialog{border:none;border-radius:16px;max-width:520px;width:calc(100% - 32px);padding:0;box-shadow:0 20px 60px rgba(15,23,42,.25)}
  dialog::backdrop{background:rgba(15,23,42,.35)}
  .dlg-h{padding:16px 20px;border-bottom:1px solid var(--line);font-weight:700}
  .dlg-b{padding:16px 20px;}
  .grid{display:grid;gap:14px}
  .two{grid-template-columns:1fr 1fr}
  label{font-size:14px;font-weight:600}
  input[type=number]{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px}
  .dlg-f{display:flex;justify-content:flex-end;gap:10px;padding:14px 20px;border-top:1px solid var(--line)}
  .badg{display:inline-block;background:#f1f5f9;color:#334155;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:6px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">⏱️</div>
        <div>
          <h1>番茄鐘 Pomodoro</h1>
          <div class="desc">專注、休息、循環——保持節奏，讓進步變成習慣。</div>
        </div>
      </div>
      <button class="btn" id="btnSettings">設定</button>
    </header>

    <section class="card">
      <div class="card-h">
        <div class="title" id="phaseLabel">專注</div>
        <div class="desc">第 <span id="cycleIdx">1</span> / <span id="cycles">4</span> 個循環</div>
      </div>
      <div class="card-b">
        <div class="center">
          <div class="timer">
            <svg viewBox="0 0 100 100" style="width:100%;height:100%;transform:rotate(-90deg)">
              <circle cx="50" cy="50" r="45" stroke="#e2e8f0" stroke-width="8" fill="none"></circle>
              <circle id="ring" cx="50" cy="50" r="45" stroke="#0f172a" stroke-width="8" fill="none" stroke-linecap="round" stroke-dasharray="282.743" stroke-dashoffset="0"></circle>
            </svg>
            <div class="mmss" id="mmss">25:00</div>
          </div>
        </div>

        <div class="controls">
          <button class="btn primary" id="btnStart">開始</button>
          <button class="btn" id="btnReset">重設</button>
        </div>
        <div class="progress"><i id="bar"></i></div>
      </div>
    </section>

    <footer>快捷鍵：空白鍵 開始/暫停 · R 重設</footer>
  </div>

  <!-- 設定 Dialog -->
  <dialog id="dlg">
    <div class="dlg-h">設定工作與休息時間</div>
    <div class="dlg-b">
      <div class="grid">
        <div>
          <label>每輪循環數 <span class="badg">專注→短休息</span></label>
          <input type="number" id="iCycles" min="2" max="6" value="4" />
        </div>
        <div class="two">
          <div>
            <label>專注（分鐘）</label>
            <input type="number" id="iWork" min="5" max="120" value="25" />
          </div>
          <div>
            <label>短休息（分鐘）</label>
            <input type="number" id="iShort" min="1" max="60" value="5" />
          </div>
        </div>
        <div>
          <label>長休息（分鐘）</label>
          <input type="number" id="iLong" min="5" max="120" value="15" />
        </div>
        <div>
          <label><input type="checkbox" id="iAuto" checked> 完成後自動開始下一階段</label>
        </div>
      </div>
    </div>
    <div class="dlg-f">
      <button class="btn" id="btnClose">取消</button>
      <button class="btn primary" id="btnSave">儲存並關閉</button>
    </div>
  </dialog>

<script>
(function(){
  const $ = (id) => document.getElementById(id);
  const els = {
    mmss: $("mmss"), ring: $("ring"), bar: $("bar"),
    btnStart: $("btnStart"), btnReset: $("btnReset"),
    btnSettings: $("btnSettings"), dlg: $("dlg"), btnSave: $("btnSave"), btnClose: $("btnClose"),
    iWork: $("iWork"), iShort: $("iShort"), iLong: $("iLong"), iCycles: $("iCycles"), iAuto: $("iAuto"),
    phaseLabel: $("phaseLabel"), cycleIdx: $("cycleIdx"), cycles: $("cycles"),
  };

  const LSKEY = 'pomodoro_html_settings';
  const DEFAULTS = { workMin:25, shortBreakMin:5, longBreakMin:15, cycles:4, autoStartNext:true };
  const S = loadSettings();

  // state
  let phase = load('phase','work'); // work | short | long
  let cycleIdx = load('cycleIdx',1);
  let isRunning = false;
  let secondsLeft = 0;
  let timer = null; // setInterval handle
  let lastTick = Date.now();

  function loadSettings(){
    try{ return Object.assign({}, DEFAULTS, JSON.parse(localStorage.getItem(LSKEY)||'{}')); }catch{ return {...DEFAULTS}; }
  }
  function saveSettings(part){
    Object.assign(S, part||{});
    localStorage.setItem(LSKEY, JSON.stringify(S));
    // 同步顯示
    els.cycles.textContent = S.cycles;
  }
  function load(k, def){
    try{ const v = localStorage.getItem('pomodoro_'+k); return v ? JSON.parse(v): def; }catch{ return def; }
  }
  function save(k, v){
    try{ localStorage.setItem('pomodoro_'+k, JSON.stringify(v)); }catch{}
  }

  // init UI with settings
  els.iWork.value = S.workMin; els.iShort.value = S.shortBreakMin; els.iLong.value = S.longBreakMin; els.iCycles.value = S.cycles; els.iAuto.checked = S.autoStartNext;
  els.cycles.textContent = S.cycles;

  function phaseSeconds(){
    if(phase==='work') return S.workMin*60;
    if(phase==='short') return S.shortBreakMin*60;
    return S.longBreakMin*60;
  }

  function setPhase(newPhase){
    phase = newPhase; save('phase', phase);
    els.phaseLabel.textContent = phase==='work' ? '專注' : (phase==='short' ? '短休息' : '長休息');
    secondsLeft = phaseSeconds();
    render();
  }

  function pad(n){return String(n).padStart(2,'0');}
  function formatMMSS(sec){return pad(Math.floor(sec/60))+':'+pad(Math.floor(sec%60));}

  function render(){
    const total = phaseSeconds();
    els.mmss.textContent = formatMMSS(secondsLeft);
    const pct = Math.max(0, Math.min(1, (total - secondsLeft)/total));
    const C = 2*Math.PI*45; // circle length
    els.ring.setAttribute('stroke-dasharray', C.toFixed(3));
    els.ring.setAttribute('stroke-dashoffset', ((1-pct)*C).toFixed(3));
    els.bar.style.width = (pct*100).toFixed(1)+'%';
    els.cycleIdx.textContent = cycleIdx;
  }

  function start(){
    if(isRunning) return; isRunning = true; lastTick = Date.now();
    els.btnStart.textContent = '暫停';
    timer = setInterval(()=>{
      const now = Date.now();
      const delta = Math.max(1, Math.round((now-lastTick)/1000));
      lastTick = now;
      secondsLeft = Math.max(0, secondsLeft - delta);
      render();
      if(secondsLeft===0){
        completePhase();
      }
    }, 1000);
  }
  function pause(){
    isRunning = false; els.btnStart.textContent = '開始';
    if(timer) clearInterval(timer), timer=null;
  }
  function toggleStart(){ isRunning ? pause() : start(); }

  function reset(){
    pause(); secondsLeft = phaseSeconds(); render();
  }

  function completePhase(){
    pause();
    // 下一階段
    if(phase==='work'){
      if(cycleIdx>=S.cycles){ setPhase('long'); cycleIdx = 1; save('cycleIdx', cycleIdx); }
      else { setPhase('short'); cycleIdx++; save('cycleIdx', cycleIdx); }
    }else{
      setPhase('work');
    }
    if(S.autoStartNext) start();
  }

  // wire up
  els.btnStart.addEventListener('click', toggleStart);
  els.btnReset.addEventListener('click', reset);
  els.btnSettings.addEventListener('click', ()=> els.dlg.showModal());
  els.btnClose.addEventListener('click', ()=> els.dlg.close());
  els.btnSave.addEventListener('click', ()=>{
    const nWork = Math.max(1, parseInt(els.iWork.value||'25'));
    const nShort = Math.max(1, parseInt(els.iShort.value||'5'));
    const nLong = Math.max(1, parseInt(els.iLong.value||'15'));
    const nCycles = Math.min(6, Math.max(2, parseInt(els.iCycles.value||'4')));
    saveSettings({ workMin:nWork, shortBreakMin:nShort, longBreakMin:nLong, cycles:nCycles, autoStartNext: !!els.iAuto.checked });
    setPhase(phase); // 依當前階段重設秒數
    els.dlg.close();
  });

  // keyboard shortcuts
  document.addEventListener('keydown', (e)=>{
    const tag = (e.target && e.target.tagName)||'';
    if(tag==='INPUT' || tag==='TEXTAREA') return;
    if(e.code==='Space'){ e.preventDefault(); toggleStart(); }
    else if(e.key==='r' || e.key==='R'){ reset(); }
  });

  // boot
  setPhase(phase);
  cycleIdx = load('cycleIdx', 1); els.cycleIdx.textContent = cycleIdx;
  render();
})();
</script>
</body>
</html>
