<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>蕃茄鐘 Pomodoro</title>
  <meta name="description" content="輕量、零安裝的蕃茄鐘（Pomodoro）網頁版，支援自訂時間、深色模式、桌面通知、聲音提醒與進度環圈。" />
  <style>
    :root{
      --bg: #0f172a;
      --panel:#111827;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --accent:#22d3ee;
      --accent-2:#60a5fa;
      --shadow: 0 20px 40px rgba(0,0,0,.35), 0 2px 8px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC, PingFang TC, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; background: radial-gradient(1200px 800px at 80% -10%, rgba(34,211,238,.12), transparent 60%), radial-gradient(1200px 800px at 0% 120%, rgba(96,165,250,.10), transparent 60%), var(--bg); color:var(--text)}
    .container{max-width:980px;margin-inline:auto;padding:24px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
    .row{display:grid;grid-template-columns:1.2fr .8fr; gap:22px}
    @media (max-width:900px){.row{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00)); border:1px solid rgba(31,41,55,1); border-radius:18px; padding:18px; box-shadow:var(--shadow)}
    .modes{display:flex;gap:10px;margin-bottom:14px}
    .tab{cursor:pointer; padding:10px 14px; border-radius:12px; border:1px solid rgba(31,41,55,1); color:var(--muted); user-select:none}
    .tab.active{color:var(--text); border-color:transparent; background:linear-gradient(135deg, rgba(34,211,238,.18), rgba(96,165,250,.18))}
    .timer-wrap{display:grid; place-items:center; padding:10px 0 6px}
    .ring{position:relative; width:320px; height:320px}
    .ring svg{width:100%; height:100%; transform:rotate(-90deg)}
    .center{position:absolute; inset:0; display:grid; place-items:center}
    .time{font-variant-numeric:tabular-nums; font-size:68px; font-weight:700}
    .sub{margin-top:4px; color:var(--muted); font-size:13px}
    .actions{display:flex; gap:10px; justify-content:center; margin-top:14px}
    .btn{cursor:pointer; padding:12px 16px; border-radius:12px; border:1px solid rgba(31,41,55,1); background:rgba(255,255,255,.02); color:var(--text); font-weight:600}
    .btn.primary{border-color:transparent; background:linear-gradient(135deg, var(--accent), var(--accent-2)); color:#07121f}
    .section-title{font-weight:700; font-size:14px; color:var(--muted); margin:2px 0 10px}
    .settings{display:grid; gap:10px}
    .field{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border:1px dashed rgba(31,41,55,1); border-radius:12px}
    .field input[type="number"]{width:90px; padding:8px 10px; border-radius:10px; border:1px solid rgba(31,41,55,1); background:#0a1222; color:var(--text)}
    .hint{font-size:12px; color:var(--muted)}
    .kbd{display:inline-grid; place-items:center; min-width:28px; height:28px; padding:0 6px; border-radius:8px; border:1px solid rgba(31,41,55,1); background:#0a1222; font-weight:700}
    .stats{display:grid; grid-template-columns:repeat(2,1fr); gap:12px}
    .chip{padding:12px; border-radius:12px; border:1px solid rgba(31,41,55,1); background:rgba(255,255,255,.02)}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div style="display:flex;gap:10px;align-items:center"><div style="width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:0 0 0 4px rgba(34,211,238,.12)"></div><h1 style="margin:0;font-size:20px">蕃茄鐘 Pomodoro</h1></div>
      <div aria-live="polite" id="status" class="hint"></div>
    </header>

    <div class="row">
      <section class="card">
        <div class="modes" role="tablist" aria-label="模式">
          <button class="tab active" data-mode="work" role="tab" aria-selected="true">工作</button>
          <button class="tab" data-mode="short" role="tab" aria-selected="false">短休息</button>
          <button class="tab" data-mode="long" role="tab" aria-selected="false">長休息</button>
        </div>

        <div class="timer-wrap">
          <div class="ring" aria-label="倒數計時">
            <svg viewBox="0 0 120 120">
              <defs><linearGradient id="g" x1="0" x2="1" y1="0" y2="1"><stop offset="0%" stop-color="#22d3ee"/><stop offset="100%" stop-color="#60a5fa"/></linearGradient></defs>
              <circle cx="60" cy="60" r="54" fill="none" stroke="rgba(255,255,255,.07)" stroke-width="8" />
              <circle id="progress" cx="60" cy="60" r="54" fill="none" stroke="url(#g)" stroke-width="8" stroke-linecap="round" stroke-dasharray="339.292" stroke-dashoffset="0" />
            </svg>
            <div class="center"><div class="time" id="time">25:00</div><div class="sub" id="sub">模式：工作</div></div>
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="toggle">開始</button>
          <button class="btn" id="reset">重設</button>
          <button class="btn" id="skip">跳過</button>
        </div>

        <div style="margin-top:14px" class="hint">快捷鍵：<span class="kbd">Space</span> 開始/暫停、<span class="kbd">R</span> 重設、<span class="kbd">S</span> 跳過、<span class="kbd">1</span>/<span class="kbd">2</span>/<span class="kbd">3</span> 切換模式</div>
      </section>

      <section class="card">
        <div class="section-title">設定</div>
        <div class="settings">
          <label class="field">工作時長（分鐘）<input id="workMins" type="number" min="1" max="180" step="1" /></label>
          <label class="field">短休息（分鐘）<input id="shortMins" type="number" min="1" max="60" step="1" /></label>
          <label class="field">長休息（分鐘）<input id="longMins" type="number" min="1" max="120" step="1" /></label>
          <label class="field">幾輪後進行長休息<input id="longEvery" type="number" min="1" max="12" step="1" /></label>
          <label class="field">自動開始下一段<input id="autoNext" type="checkbox" /></label>
          <label class="field">聲音提醒<input id="soundOn" type="checkbox" /></label>
          <div class="field" style="display:block"><div style="display:flex;align-items:center;justify-content:space-between"><div>桌面通知</div><button id="notifyBtn" class="btn" style="padding:8px 12px">啟用</button></div><div class="hint">完成或切換時會彈出通知（需允許權限）。</div></div>
        </div>

        <div class="section-title" style="margin-top:14px">今日統計</div>
        <div class="stats"><div class="chip"><div class="hint">完成的番茄</div><strong id="statPoms">0</strong></div><div class="chip"><div class="hint">完成的工作分鐘</div><strong id="statMins">0</strong></div></div>
      </section>
    </div>

    <footer style="margin-top:16px;text-align:center;color:var(--muted);font-size:12px">由你掌控專注。資料保存在本機（LocalStorage）。</footer>
  </div>

  <audio id="beep" preload="auto"></audio>

  <script>
  const $ = (s)=>document.querySelector(s);
  const fmt = (n)=>String(n).padStart(2,'0');
  const circleLen = 2*Math.PI*54;

  function todayKey(){return new Date().toISOString().slice(0,10);} 

  const store = {
    get(){try{return JSON.parse(localStorage.getItem('pomodoro-settings')||'{}')}catch{return{}}},
    set(v){localStorage.setItem('pomodoro-settings', JSON.stringify(v))},
    statsGet(){try{return JSON.parse(localStorage.getItem('pomodoro-stats')||'{}')}catch{return{}}},
    statsSet(v){localStorage.setItem('pomodoro-stats', JSON.stringify(v))}
  };

  const state = {
    mode:'work', running:false, remainingSec:25*60, totalSec:25*60, cyclesCompleted:0,
    settings:{workMins:25, shortMins:5, longMins:15, longEvery:4, autoNext:false, soundOn:true}
  };

  // init beep
  (function(){const audio = $('#beep'); try{ const C = window.AudioContext||window.webkitAudioContext; const ctx = new C(); audio.playBeep = async function(){ if(!state.settings.soundOn) return; try{ if(ctx.state==='suspended') await ctx.resume(); const o = ctx.createOscillator(); const g = ctx.createGain(); o.type='sine'; o.frequency.value=880; g.gain.value=0.001; o.connect(g); g.connect(ctx.destination); o.start(); const t = ctx.currentTime; g.gain.setTargetAtTime(0.08,t,0.01); g.gain.setTargetAtTime(0.0001,t+0.25,0.05); o.stop(t+0.4);}catch(e){} } }catch(e){ audio.playBeep = ()=>{ if(!state.settings.soundOn) return; audio.src='data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAABkYXRhBAAAAAAA'; audio.play().catch(()=>{}); } }})();

  function notify(title, body){ if(document.hidden && 'Notification' in window && Notification.permission==='granted'){ const n = new Notification(title,{body}); setTimeout(()=>n.close(),5000); } }

  $('#notifyBtn').addEventListener('click', async ()=>{ if(!('Notification' in window)) return setStatus('此瀏覽器不支援通知'); if(Notification.permission==='granted') return setStatus('通知已啟用'); const res = await Notification.requestPermission(); setStatus(res==='granted'?'通知已啟用':'通知被拒絕'); });

  function setStatus(t){ $('#status').textContent = t; setTimeout(()=>$('#status').textContent='',3000);} 

  function render(){
    const mins = Math.floor(state.remainingSec/60), secs = state.remainingSec%60;
    $('#time').textContent = `${fmt(mins)}:${fmt(secs)}`;
    const label = state.mode==='work'?'工作': state.mode==='short'?'短休息':'長休息'; $('#sub').textContent = `模式：${label}`;
    const frac = 1 - (state.remainingSec / state.totalSec);
    $('#progress').setAttribute('stroke-dasharray', circleLen);
    $('#progress').setAttribute('stroke-dashoffset', String(frac * circleLen));

    // Toggle button text logic:
    // running -> 暫停
    // not running and timer at full length -> 開始
    // not running and timer partial -> 繼續
    const toggle = $('#toggle');
    if(state.running) toggle.textContent = '暫停';
    else if(state.remainingSec === state.totalSec) toggle.textContent = '開始';
    else toggle.textContent = '繼續';

    // stats
    const stats = store.statsGet(); const today = stats[todayKey()] || {poms:0, workMins:0}; $('#statPoms').textContent = today.poms; $('#statMins').textContent = today.workMins;

    // inputs
    const s = state.settings; $('#workMins').value = s.workMins; $('#shortMins').value = s.shortMins; $('#longMins').value = s.longMins; $('#longEvery').value = s.longEvery; $('#autoNext').checked = s.autoNext; $('#soundOn').checked = s.soundOn;

    document.querySelectorAll('.tab').forEach(b=>{ b.classList.toggle('active', b.dataset.mode===state.mode); b.setAttribute('aria-selected', String(b.dataset.mode===state.mode)); });
  }

  function setMode(mode){ state.mode = mode; const mins = mode==='work'?state.settings.workMins: mode==='short'?state.settings.shortMins: state.settings.longMins; state.totalSec = Math.max(1, Math.round(mins*60)); state.remainingSec = state.totalSec; state.running = false; render(); }

  let rafId=null, lastTs=0, acc=0;
  function loop(ts){ rafId = requestAnimationFrame(loop); if(!state.running){ lastTs = ts; return; } if(!lastTs) lastTs = ts; const dt=(ts-lastTs)/1000; lastTs=ts; acc+=dt; while(acc>=1){ acc-=1; tick(); } }
  function start(){ if(!state.running){ state.running=true; lastTs=0; acc=0; render(); }}
  function pause(){ state.running=false; render(); }
  function tick(){ if(state.remainingSec>0){ state.remainingSec--; render(); return; }
    // reached zero
    pause(); $('#beep').playBeep && $('#beep').playBeep(); const label = state.mode==='work'?'工作':'休息'; notify('時間到', `${label} 結束啦！`);
    // stats
    const stats = store.statsGet(); const key = todayKey(); stats[key] = stats[key]||{poms:0, workMins:0}; if(state.mode==='work'){ stats[key].poms++; stats[key].workMins += state.settings.workMins; } store.statsSet(stats);
    // ensure button shows 開始 by resetting mode (setMode will set remaining to full and running=false)
    nextSegment(); // nextSegment internally calls setMode to prepare next segment
    // if autoNext is enabled, start next immediately
    if(state.settings.autoNext) start();
  }

  function nextSegment(){ if(state.mode==='work'){ state.cyclesCompleted++; const doLong = (state.cyclesCompleted % state.settings.longEvery)===0; setMode(doLong? 'long' : 'short'); } else { setMode('work'); } }

  // events
  $('#toggle').addEventListener('click', ()=>{ if(state.running) pause(); else start(); });
  $('#reset').addEventListener('click', ()=>{ setMode(state.mode); setStatus('已重設'); });
  $('#skip').addEventListener('click', ()=>{ nextSegment(); setStatus('已跳過'); });
  document.querySelectorAll('.tab').forEach(b=> b.addEventListener('click', ()=> setMode(b.dataset.mode)) );

  document.addEventListener('keydown', (e)=>{ if(e.target && ['INPUT','TEXTAREA'].includes(e.target.tagName)) return; if(e.code==='Space'){ e.preventDefault(); state.running ? pause() : start(); } if(e.key==='r' || e.key==='R'){ setMode(state.mode); setStatus('已重設'); } if(e.key==='s' || e.key==='S'){ nextSegment(); setStatus('已跳過'); } if(e.key==='1'){ setMode('work'); } if(e.key==='2'){ setMode('short'); } if(e.key==='3'){ setMode('long'); } });

  // inputs
  function clampNum(v,min,max){ v = Number(v)||min; return Math.min(max, Math.max(min, Math.round(v))); }
  $('#workMins').addEventListener('change', e=>{ state.settings.workMins = clampNum(e.target.value,1,180); persistSettings(); if(state.mode==='work') setMode('work'); });
  $('#shortMins').addEventListener('change', e=>{ state.settings.shortMins = clampNum(e.target.value,1,60); persistSettings(); if(state.mode==='short') setMode('short'); });
  $('#longMins').addEventListener('change', e=>{ state.settings.longMins = clampNum(e.target.value,1,120); persistSettings(); if(state.mode==='long') setMode('long'); });
  $('#longEvery').addEventListener('change', e=>{ state.settings.longEvery = clampNum(e.target.value,1,12); persistSettings(); });
  $('#autoNext').addEventListener('change', e=>{ state.settings.autoNext = !!e.target.checked; persistSettings(); });
  $('#soundOn').addEventListener('change', e=>{ state.settings.soundOn = !!e.target.checked; persistSettings(); });

  function persistSettings(){ store.set(state.settings); setStatus('設定已保存'); }
  function loadSettings(){ const s = Object.assign({}, state.settings, store.get()); s.workMins = clampNum(s.workMins,1,180); s.shortMins = clampNum(s.shortMins,1,60); s.longMins = clampNum(s.longMins,1,120); s.longEvery = clampNum(s.longEvery,1,12); s.autoNext = !!s.autoNext; s.soundOn = s.soundOn!==false; state.settings = s; }

  (function init(){ loadSettings(); setMode('work'); render(); loop(); })();
  </script>
</body>
</html>
